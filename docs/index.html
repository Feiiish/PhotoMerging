<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sprite Sheet 生成工具</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <h1>Image merge tool</h1> <!-- 标题独立，居中 -->
    <div id="container">
        <h2>Thanks for using ^^</h2>

        <!-- 文件选择和行数输入放在一行 -->
        <div class="input-group">
            <input type="file" id="fileInput" multiple accept="image/*">
            <label for="columnsInput">Numbers per row：</label>
            <input type="number" id="columnsInput" min="1" value="3" style="width: 50px;">
        </div>

        <!-- 更大的合并按钮 -->
        <button id="mergeBtn" onclick="mergeAndDownload()">Merge</button>

        <h3>preview:</h3>
        <div id="preview"></div>

        <h3>result:</h3>
        <canvas id="spriteCanvas"></canvas>
    </div>

 <script>
    let images = [];           // 存放 Image 对象（顺序决定最终排列顺序）
    let imageBlobs = [];       // 存放原始 File 对象对应的 blob URL（用于预览）

    // 当选择文件后
    document.getElementById("fileInput").addEventListener("change", function(event) {
        images = [];
        imageBlobs = [];
        const previewDiv = document.getElementById("preview");
        previewDiv.innerHTML = "";

        Array.from(event.target.files).forEach(file => {
            const blobUrl = URL.createObjectURL(file);
            imageBlobs.push(blobUrl);

            const img = new Image();
            img.src = blobUrl;
            img.onload = () => {
                images.push(img);
            };

            // 创建可拖动的预览项
            const item = document.createElement("div");
            item.className = "preview-item";
            item.draggable = true;
            item.dataset.index = imageBlobs.length - 1;

            const previewImg = document.createElement("img");
            previewImg.src = blobUrl;

            previewImg.style.objectFit = "cover";
            previewImg.style.borderRadius = "4px";

            const removeBtn = document.createElement("span");
            removeBtn.textContent = "×";
            removeBtn.style.marginLeft = "5px";
            removeBtn.style.cursor = "pointer";
            removeBtn.style.color = "red";
            removeBtn.style.fontSize = "18px";
            removeBtn.onclick = () => removeImage(item);

            item.appendChild(previewImg);
            item.appendChild(removeBtn);
            previewDiv.appendChild(item);
        });

        // 绑定拖拽事件（在所有图片加载完后也可以，这里直接在每次选择文件后重新绑定）
        makeSortable();
    });

    // 删除某张图片
    function removeImage(item) {
        const index = Array.from(item.parentNode.children).indexOf(item);
        // 移除对应的 Image 对象和 blobURL
        images.splice(index, 1);
        URL.revokeObjectURL(imageBlobs[index]);
        imageBlobs.splice(index, 1);

        // 重新渲染列表
        renderPreviewList();
    }

    // 重新渲染预览列表（删除或拖拽后调用）
    function renderPreviewList() {
        const previewDiv = document.getElementById("preview");
        previewDiv.innerHTML = "";

        imageBlobs.forEach((blobUrl, i) => {
            const item = document.createElement("div");
            item.className = "preview-item";
            item.draggable = true;
            item.dataset.index = i;

            const img = document.createElement("img");
            img.src = blobUrl;
            img.style.width = "60px";
            img.style.height = "60px";
            img.style.objectFit = "cover";
            img.style.borderRadius = "4px";

            const removeBtn = document.createElement("span");
            removeBtn.textContent = "×";
            removeBtn.style.marginLeft = "5px";
            removeBtn.style.cursor = "pointer";
            removeBtn.style.color = "red";
            removeBtn.style.fontSize = "18px";
            removeBtn.onclick = () => removeImage(item);

            item.appendChild(img);
            item.appendChild(removeBtn);
            previewDiv.appendChild(item);
        });

        makeSortable();
    }

    function syncImagesByBlobs() {
    images = imageBlobs.map(url => {
        let img = new Image();
        img.src = url;
        return img;
    });
}


    // 拖拽排序核心
    let draggedItem = null;

    function makeSortable() {
        const items = document.querySelectorAll(".preview-item");
        items.forEach(item => {
            item.addEventListener("dragstart", e => {
                draggedItem = item;
                setTimeout(() => item.style.opacity = "0.5", 0);
            });

            item.addEventListener("dragend", e => {
                setTimeout(() => {
                    draggedItem.style.opacity = "1";
                    draggedItem = null;
                }, 0);
            });

            item.addEventListener("dragover", e => e.preventDefault());
            item.addEventListener("dragenter", e => e.preventDefault());

            item.addEventListener("drop", e => {
                e.preventDefault();
                if (draggedItem !== item) {
                    const allItems = Array.from(item.parentNode.children);
                    const fromIndex = allItems.indexOf(draggedItem);
                    const toIndex = allItems.indexOf(item);

                    // 交换 images 和 imageBlobs 的顺序
                    [images[fromIndex], images[toIndex]] = [images[toIndex], images[fromIndex]];
                    [imageBlobs[fromIndex], imageBlobs[toIndex]] = [imageBlobs[toIndex], imageBlobs[fromIndex]];

                    // 重新渲染保持顺序一致
                    renderPreviewList();
                }
            });
        });
    }
function mergeAndDownload() {
    if (images.length === 0) {
        alert("请先上传图片！");
        return;
    }
    syncImagesByBlobs();
    const columns = Math.max(1, parseInt(document.getElementById("columnsInput").value) || 1);

    // 计算每一列最大宽度（用于对齐）
    const colMaxWidth = new Array(columns).fill(0);
    images.forEach((img, i) => {
        const col = i % columns;
        colMaxWidth[col] = Math.max(colMaxWidth[col], img.naturalWidth);
    });

    // 预先计算最终尺寸
    let totalHeight = 0;
    let maxRowHeight = 0;

    images.forEach((img, i) => {
        const col = i % columns;

        maxRowHeight = Math.max(maxRowHeight, img.naturalHeight);

        if (col === columns - 1 || i === images.length - 1) {
            totalHeight += maxRowHeight;
            maxRowHeight = 0;
        }
    });

    const totalWidth = colMaxWidth.reduce((a,b)=>a+b, 0);

    // 创建最终画布（透明背景，无 padding）
    const finalCanvas = document.getElementById("spriteCanvas");
    finalCanvas.width  = totalWidth;
    finalCanvas.height = totalHeight;

    const ctx = finalCanvas.getContext("2d");
    ctx.imageSmoothingEnabled = false;

    let xOffsets = [];
    let xSum = 0;
    colMaxWidth.forEach(w => { xOffsets.push(xSum); xSum += w; });

    let rowY = 0;
    let rowMaxHeight = 0;

    images.forEach((img, i) => {
        const col = i % columns;

        ctx.drawImage(img, xOffsets[col], rowY, img.naturalWidth, img.naturalHeight);

        rowMaxHeight = Math.max(rowMaxHeight, img.naturalHeight);

        if (col === columns - 1 || i === images.length - 1) {
            rowY += rowMaxHeight;
            rowMaxHeight = 0;
        }
    });

    // 下载
    finalCanvas.toBlob(blob => {
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.download = `sprite_sheet_${finalCanvas.width}x${finalCanvas.height}.png`;
        a.href = url;
        a.click();
        URL.revokeObjectURL(url);
    }, "image/png");
}


</script>

<!-- 简单的样式，让拖拽更好看 -->
<style>
    #preview {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        padding: 15px;
        border: 2px dashed #ccc;
        border-radius: 12px;
        background: #fafafa;
        margin: 20px 0;
        max-width: 100%;
        overflow-x: auto;
    }

    .preview-item {
        flex: 0 0 auto;
        display: flex;
        align-items: center;
        background: white;
        padding: 8px;
        border-radius: 10px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        cursor: move;
        user-select: none;
        transition: all 0.2s;
    }

    .preview-item:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(0,0,0,0.15);
    }

    .preview-item img {
        width: 80px !important;      /* 强制固定宽度 */
        height: 80px !important;     /* 强制固定高度 */
        object-fit: contain;         /* 完整显示，不裁剪 */
        background: #fff;            /* 防止透明图看起来“漂浮” */
        border-radius: 6px;
        border: 1px solid #eee;
    }

    .preview-item span {
        margin-left: 8px;
        font-size: 24px;
        color: #ff4444;
        cursor: pointer;
        width: 28px;
        height: 28px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        background: rgba(255,68,68,0.1);
    }

    .preview-item span:hover {
        background: rgba(255,68,68,0.2);
    }
#spriteCanvas {
    max-width: 100%;
    height: auto;
    display: block;
    margin: 20px auto;
    border: 2px solid #333;
    border-radius: 12px;
    box-shadow: 0 8px 30px rgba(0,0,0,0.2);
    background: #fff url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAMElEQVQ4jWNgYGBgYGD4z0ABYBwUAOSHUqA6qA6qY0hAhYCBgYGBg+HDhz8MABaIAQAl0QfJ9EmOcQAAAABJRU5ErkJggg==') repeat; /* 可选：透明格子背景 */
}
</style>

</body>
</html>
