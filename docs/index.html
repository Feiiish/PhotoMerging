<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sprite Sheet 生成工具</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <h1>Image merge tool</h1> <!-- 标题独立，居中 -->
    <div id="container">
        <h2>Thanks for using ^^</h2>

        <!-- 文件选择和行数输入放在一行 -->
        <div class="input-group">
            <input type="file" id="fileInput" multiple accept="image/*">
            <label for="columnsInput">Numbers per row：</label>
            <input type="number" id="columnsInput" min="1" value="3" style="width: 50px;">
        </div>

        <!-- 更大的合并按钮 -->
        <button id="mergeBtn" onclick="mergeAndDownload()">Merge</button>

        <h3>preview:</h3>
        <div id="preview"></div>

        <h3>result:</h3>
        <canvas id="spriteCanvas"></canvas>
    </div>

  <script>
    let images = [];
    let fileList = []; // 保存文件顺序，支持排序

    document.getElementById("fileInput").addEventListener("change", function(event) {
        images = [];
        fileList = Array.from(event.target.files);

        const preview = document.getElementById("preview");
        preview.innerHTML = "";
        preview.classList.add("draggable-list");

        fileList.forEach((file, index) => {
            const reader = new FileReader();
            reader.onload = function(e) {
                const li = document.createElement("div");
                li.className = "draggable-item";
                li.draggable = true;
                li.dataset.index = index;

                li.innerHTML = `<img src="${e.target.result}" style="width:50px;">`;

                preview.appendChild(li);

                const img = new Image();
                img.src = e.target.result;
                img.onload = () => images[index] = img;
            };
            reader.readAsDataURL(file);
        });

        enableDragSort();
    });

    function enableDragSort() {
        const container = document.getElementById("preview");
        let dragging = null;

        container.addEventListener("dragstart", (e) => {
            if (e.target.classList.contains("draggable-item")) {
                dragging = e.target;
                e.dataTransfer.effectAllowed = "move";
            }
        });

        container.addEventListener("dragover", (e) => {
            e.preventDefault();
            const target = e.target.closest(".draggable-item");
            if (target && target !== dragging) {
                const rect = target.getBoundingClientRect();
                const offset = e.clientY - rect.top;
                if (offset > rect.height / 2) {
                    target.after(dragging);
                } else {
                    target.before(dragging);
                }
            }
        });

        container.addEventListener("drop", () => updateImageOrder());
    }

    // 更新 images 数组顺序
    function updateImageOrder() {
        const items = document.querySelectorAll(".draggable-item");
        const newImages = [];

        items.forEach(item => {
            const idx = item.dataset.index;
            newImages.push(images[idx]);
        });

        images = newImages;
    }

    function mergeAndDownload() {
        if (images.length === 0) {
            alert("Please upload images first！");
            return;
        }

        const columns = parseInt(document.getElementById("columnsInput").value) || 1;
        const rows = Math.ceil(images.length / columns);

        let maxWidth = 0, maxHeight = 0;
        images.forEach(img => {
            maxWidth = Math.max(maxWidth, img.width);
            maxHeight = Math.max(maxHeight, img.height);
        });

        const canvas = document.getElementById("spriteCanvas");
        canvas.width = columns * maxWidth;
        canvas.height = rows * maxHeight;

        const ctx = canvas.getContext("2d");

        let x = 0, y = 0;
        images.forEach(img => {
            ctx.drawImage(img, x * maxWidth, y * maxHeight);
            x++;
            if (x >= columns) { x = 0; y++; }
        });

        canvas.style.width = "100%";
        canvas.style.maxWidth = "400px";
        canvas.style.height = "auto";

        const link = document.createElement("a");
        link.download = "sprite_sheet.png";
        link.href = canvas.toDataURL("image/png");
        link.click();
    }
</script>

</body>
</html>
